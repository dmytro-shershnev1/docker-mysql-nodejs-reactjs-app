# deployment.yml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: users-app
  labels:
    app: users-app
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: users-app
    template:
      metadata:
        labels:
          app: users-app
      spec:
        containers:
          # users-app container
          - name: users-app-container
            image: europe-west1-docker.pkg.dev/app-project-431616/app-docker-repo/frontend-image:latest
            imagePullPolicy: IfNotPresent
            # users-app always starts on this port
            ports:
              - containerPort: 3000
          - name: cloudsql-proxy
            image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:latest
            command: [ "/cloud_sql_proxy",
                       "-instances=[app-project-431616:europe-west1:mysql-instance]=tcp:3306",
                       "-credential_file=/secrets/cloudsql/credentials.json" ]
            volumeMounts:
              - name: cloudsql-instance-credentials
                mountPath: /secrets/cloudsql
                readOnly: true
            # resource cloudsql needs
            resources:
              requests:
                cpu: "15m"
                memory: "64Mi"
              limits:
                cpu: "20m"
                memory: "128Mi"
        volumes:
          # db credentials stored in this volume to access our mysql
          - name: cloudsql-instance-credentials
            secret:
              secretName: cloudsql-instance-credentials
          - name: cloudsql
            emptyDir:
